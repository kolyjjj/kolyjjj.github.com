<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!--<![endif]-->

<head>
  <title>Javascript后端开发(二) | Koly&#39;s blog</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Koly's blog">
    <meta name="author" content="koly">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <!-- <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico"> -->

    <link rel="apple-touch-icon" sizes="57x57" href="/img/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/img/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/img/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/img/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/img/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/img/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/img/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/img/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/img/favicon/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/img/favicon/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16.png">
<link rel="manifest" href="/img/favicon/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/img/favicon/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">

    <link rel="alternate" href="/atom.xml" title="Koly&#39;s blog" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
	
    <link rel="stylesheet" href="/highlightjs/github.css" type="text/css">
    


    <!-- Custom stylesheet, (add custom styles here, always load last) -->
    <!-- Load our stylesheet for IE8 -->
    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- Google Webfonts (Monserrat 400/700, Open Sans 400/600) -->
    <link href='//fonts.useso.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
    <link href='//fonts.useso.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'>

    <!-- Load our fonts individually if IE8+, to avoid faux bold & italic rendering -->
    <!--[if IE]>
    <link href='http://fonts.useso.com/css?family=Montserrat:400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Montserrat:700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Open+Sans:400' rel='stylesheet' type='text/css'>
    <link href='http://fonts.useso.com/css?family=Open+Sans:600' rel='stylesheet' type='text/css'>
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->










  
  
  

  
  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <div class="author">
            <a href="/about">
              <img src="/img/koly.png" alt="author"/>
            </a>
            <p>
              koly
            </p>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            
        	<li>
        		<a class="sb-toggle-submenu">Categories<span class="sb-caret"></span></a>
            	<ul class="sb-submenu">
				  	
            
				    
            
				    <li><a href="/categories/Tech/" class="animsition-link">Tech<small>(17)</small></a></li>
            
				    
              </ul>
        	</li>
			
            
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a href="https://github.com/kolyjjj" class="animsition-link">github</a></li>
                    
                    <li><a href="http://www.douban.com/people/59390507/notes" class="animsition-link">douban</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            <li><a href="/about" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>

    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">Koly's blog</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/kolyjjj" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            
                            
                            
                            <li class="nolink"><span>Welcome!</span></li>
                            <li class="nolink"><span>86.2k words</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->

      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2016-03-14T16:26:15.000Z" itemprop="datePublished">
          2016-03-15
      </time>
      |
      <a class="no-links">14,683 words</a>
    
    
    | 
    <a href='/tags/NodeJS/'>NodeJS</a>
    
    
</span>

                <h1>Javascript后端开发(二)</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<p>本文接着上文<a href="http://koly.me/2016/01/26/Javascript%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/" target="_blank" rel="external">《Javascript后端开发学习》</a>。将继续记录学习NodeJS后端开发的“流水”。这篇主要是记录comments的CRUD。<a id="more"></a></p>
<h2 id="编码前的思考"><a href="#编码前的思考" class="headerlink" title="编码前的思考"></a>编码前的思考</h2><p>主要有两个方面：</p>
<ul>
<li>数据库的表设计，即post和comment的关系</li>
<li>api的设计，即url的设计</li>
</ul>
<p>先说第一个，表设计。详细的表设计流程可以参考<a href="http://koly.me/2015/11/03/%E3%80%90%E8%AF%91%E3%80%91%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1%E5%9F%BA%E7%A1%80/" target="_blank" rel="external">《数据库设计基础》</a>。这里明显有两个实体，一个是post，另一个是comment。实体之间的关系一般有一对一，一对多，多对多。由于一个post可以对应多个comment，而同一个comment不能同时属于两个不同的post，所以post和comment的关系是一对多关系，即一个post对应多个comment。如果在关系数据库中，则需要建立一张post表，一张comment表，然后在comment表中使用一列来存储post的id以表示该条记录所属于的post。在mongodb中对一对多的实现由两种方式:</p>
<ul>
<li>嵌入式文档(<a href="https://docs.mongodb.org/manual/tutorial/model-embedded-one-to-many-relationships-between-documents/" target="_blank" rel="external">embedded document</a>)</li>
<li>文档引用(<a href="https://docs.mongodb.org/manual/tutorial/model-referenced-one-to-many-relationships-between-documents/" target="_blank" rel="external">document references</a>)。</li>
</ul>
<p>嵌入式文档的意思就是说在表示post的一个json里面有一个数组，然后这个数组的每个元素就是一个comment。文档引用就是，post是一个文档，而comment是另一个文档，post文档有一个<code>_id</code>，在comment文档里面增加一个属性，然后使用post的那个<code>_id</code>来表示该comment属于哪个文档。第一种方式在读取post的时候就可以读取该post对应的comments，对于一个post，只需要一次查询就可以得到该post的内容和对应的所有comments。第二种方式需要两次查询才能拿到post及对应的comments。这里考虑到从用户的角度来说post相对comment来说更为重要一些，有的时候甚至没有comment也没有太大的影响。同时如果comments过多的话可能会影响响应时间，而用户可能希望首先看到post的内容。所以从用户的行为习惯出发，更倾向于将post和comment分开，使用分开的查询，这样可以尽可能保证post的相应速度，优先显示出post。技术上来说，使用一个单独的请求来获取comment，在comment变多的时候可以考虑分页处理，而不会影响post，甚至于将comment作为单独的一个模块独立出去，比如<a href="https://disqus.com/home/explore/" target="_blank" rel="external">DISQUS</a>。所以最后决定采取第二种方式。</p>
<p>api的设计，就遵循Restful API的设计风格，考虑到两个资源的关系，comment的主api是<code>/api/post/&lt;post_id&gt;/comments/</code>，对应的CRUD就是POST, GET, PUT, DELETE。</p>
<p>那么想到这里就可以试着开始开发了。</p>
<h2 id="自顶向下"><a href="#自顶向下" class="headerlink" title="自顶向下"></a>自顶向下</h2><p>所谓的“自顶向下”就是从api开始写，知道写到最后的数据库操作。这里顶就是上层，下就是底层。一般认为数据库比较底层。从api开始写，自然就是api的定义，这属于路由(router)的一部分。按照Restful API的风格，comments的路由应该是：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create =&gt; POST /api/posts/&lt;post_id&gt;/comments</span><br><span class="line">get comments =&gt; GET /api/posts/&lt;post_id&gt;/comments</span><br><span class="line">get one comment =&gt; GET /api/posts/&lt;post_id&gt;/comments/&lt;comment_id&gt;</span><br><span class="line">update comment =&gt; PUT /api/posts/&lt;post_id&gt;/comments/&lt;comment_id&gt;</span><br><span class="line">delete comment =&gt; DELETE /api/posts/&lt;post_id&gt;/comments/&lt;comment_id&gt;</span><br></pre></td></tr></table></figure></p>
<p>从url中可以看到，comments与posts是一种从属关系，既comments是属于posts的。在开发的时候，comments被当做一个单独的独立于comments的模块，主要是基于其本身可以可能独立出去的性质。所以comments在一个单独的文件夹下面。先是总的路由分发：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// routers.js</span></span><br><span class="line"><span class="keyword">import</span> commentRouter <span class="keyword">from</span> <span class="string">'./comments/router'</span>;</span><br><span class="line">...</span><br><span class="line">router.use(<span class="string">'/posts/:id/comments/'</span>, commentRouter);</span><br></pre></td></tr></table></figure></p>
<p>然后是comments模块自身的路由，刚开始只实现了一个假的get comments:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/comments/</span></span><br><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> express <span class="keyword">from</span> <span class="string">'express'</span>;</span><br><span class="line"><span class="keyword">import</span> commentsdb <span class="keyword">from</span> <span class="string">'./commentsdb'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, (req, res)=&gt;&#123;</span><br><span class="line">  res.status(<span class="number">200</span>).send(<span class="string">'hello, comments'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br></pre></td></tr></table></figure></p>
<p>这样就将comments相关的路由分配到了对应的comments模块。同样也建立<code>commentsdb.js</code>来处理数据库的相关操作，当然一开始里面也是什么也没有，只作一个架子。</p>
<h2 id="数据操作代码的重构"><a href="#数据操作代码的重构" class="headerlink" title="数据操作代码的重构"></a>数据操作代码的重构</h2><p>在做comments的数据库的记录插入的时候，发现也需要创建一个数据库连接以及建立一个model，而这部分代码跟posts那边的代码几乎一样，对于重复代码，自然要重构掉。于是在开发新功能前先进行了重构：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/database/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> mongoose <span class="keyword">from</span> <span class="string">'mongoose'</span>;</span><br><span class="line"><span class="keyword">import</span> dbConfig <span class="keyword">from</span> <span class="string">'../../env/db_config'</span>;</span><br><span class="line"></span><br><span class="line">mongoose.connect(dbConfig.url);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> db = mongoose.connection;</span><br><span class="line">db.on(<span class="string">'error'</span>, <span class="built_in">console</span>.error.bind(<span class="built_in">console</span>, <span class="string">'connection error:'</span>));</span><br><span class="line">db.once(<span class="string">'open'</span>, ()=&gt;&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'connected to mongodb'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Schema = mongoose.Schema;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createModel</span>(<span class="params">name, schema</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> mongoose.model(name, <span class="keyword">new</span> Schema(schema));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> createModel;</span><br></pre></td></tr></table></figure></p>
<p>将重复代码提取到了<code>database/index.js</code>中，将<code>createModel</code>方法export出去，作为提供数据操作的接口。到这儿的时候，心里想这个<code>index.js</code>文件会被多次<code>import</code>，这种多次import会不会导致代码的多次执行，这样就会有多个connection。后来google了一下，发现只会执行一次，换句话说你export出去的东西应该都是一个单例的Object。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/posts/postsdb.js</span></span><br><span class="line"><span class="keyword">import</span> createModel <span class="keyword">from</span> <span class="string">'../database/index'</span>;</span><br><span class="line"><span class="keyword">const</span> schema = &#123;</span><br><span class="line">  title:&#123;</span><br><span class="line">    type: <span class="built_in">String</span>,</span><br><span class="line">    required: <span class="string">'&#123;PATH&#125; cannot be empty.'</span>, <span class="comment">// PATH must be uppercase</span></span><br><span class="line">    minlength: [<span class="number">4</span>, <span class="string">'&#123;PATH&#125; should be more than 4 characters.'</span>]</span><br><span class="line">  &#125;, </span><br><span class="line">  author: &#123;</span><br><span class="line">    type: <span class="built_in">String</span>,</span><br><span class="line">    required: <span class="string">'&#123;PATH&#125; cannot be empty.'</span>, </span><br><span class="line">    minlength: [<span class="number">2</span>, <span class="string">'&#123;PATH&#125; should be more than 2 characters.'</span>],</span><br><span class="line">    maxlength: [<span class="number">40</span>, <span class="string">'&#123;PATH&#125; should be less than 40 characters.'</span>]</span><br><span class="line">  &#125;, </span><br><span class="line">  content: &#123;</span><br><span class="line">    type: <span class="built_in">String</span>,</span><br><span class="line">    required: <span class="string">'&#123;PATH&#125; cannot be empty.'</span>,</span><br><span class="line">    minlength: [<span class="number">15</span>, <span class="string">'&#123;PATH&#125; should be more than 15 characters.'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  comments: [&#123;body: <span class="built_in">String</span>, date: <span class="built_in">Date</span>&#125;],</span><br><span class="line">  created_date: &#123;type: <span class="built_in">Date</span>, <span class="keyword">default</span>: <span class="built_in">Date</span>.now&#125;,</span><br><span class="line">  last_edit_date: &#123;type: <span class="built_in">Date</span>, <span class="keyword">default</span>: <span class="built_in">Date</span>.now&#125;,</span><br><span class="line">  hidden: <span class="built_in">Boolean</span>,</span><br><span class="line">  meta: &#123;</span><br><span class="line">    votes: <span class="built_in">Number</span>,</span><br><span class="line">    favs: <span class="built_in">Number</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Blog = createModel(<span class="string">'Blog'</span>, schema);</span><br></pre></td></tr></table></figure></p>
<p>对比之前的代码，postsdb.js中剥离出了具体的数据库相关操作。在postsdb中的代码就是完全关于posts的数据库操作的。这里就实现了<strong>SRP(Single Responsiblity Principle)</strong>，即单一职责原则，此时的postsdb相比之前，就做了一件事情，之前既要负责数据库连接的建立也要负责posts的CRUD。</p>
<h2 id="创建comment"><a href="#创建comment" class="headerlink" title="创建comment"></a>创建comment</h2><p>先来一段测试代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test/comments/api.spec.js</span></span><br><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">'supertest'</span>;</span><br><span class="line"><span class="keyword">import</span> should <span class="keyword">from</span> <span class="string">'should'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">async</span> <span class="keyword">from</span> <span class="string">'async'</span>;</span><br><span class="line"><span class="keyword">import</span> app <span class="keyword">from</span> <span class="string">'../../app'</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'comments operation'</span>, ()=&gt;&#123;</span><br><span class="line">  <span class="keyword">let</span> aPost = &#123;</span><br><span class="line">    <span class="string">"title"</span>:<span class="string">"A new Post for comment test"</span>,</span><br><span class="line">    <span class="string">"author"</span>:<span class="string">"koly"</span>,</span><br><span class="line">    <span class="string">"content"</span>:<span class="string">"This is a post for testing comments"</span>,</span><br><span class="line">    <span class="string">"hidden"</span>:<span class="literal">false</span>,</span><br><span class="line">    <span class="string">"meta"</span>:[]</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> aComment =  &#123;</span><br><span class="line">    <span class="string">"author"</span>:<span class="string">"koly"</span>,</span><br><span class="line">    <span class="string">"content"</span>:<span class="string">"this is a comment"</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'should create a comment'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>&#123;</span><br><span class="line">    request(app)</span><br><span class="line">    .post(<span class="string">'/api/posts'</span>)</span><br><span class="line">    .send(aPost)</span><br><span class="line">    .expect(<span class="number">200</span>)</span><br><span class="line">    .end((err, res)=&gt;&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'post id'</span>, res.body.id);</span><br><span class="line">      request(app)</span><br><span class="line">      .post(<span class="string">'/api/posts/'</span> + res.body.id + <span class="string">'/comments'</span>)</span><br><span class="line">      .send(aComment)</span><br><span class="line">      .expect(<span class="string">'Content-Type'</span>, <span class="regexp">/json/</span>)</span><br><span class="line">      .expect((res)=&gt;&#123;</span><br><span class="line">        res.body.should.have.property(<span class="string">'_id'</span>);</span><br><span class="line">      &#125;)</span><br><span class="line">      .expect(<span class="number">200</span>, done);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>可以看到这里跟posts的测试代码也有一些重复的地方，上面一节说了对于重复的地方要进行重构。但是这里笔者以为对于产品代码和测试代码，重构的标准应当进行区分。产品代码更在乎简洁性，而测试代码对简洁性的要求不高，更在乎的是可读性，以及测试的<strong>阅读完整性</strong>。比如，这个测试在这里，只需要看这个单独的文件就能够看懂，而如果将重复的部分抽取到其他地方的话，那么在看这个测试的时候，就需要跳转到其他文件，先理解了其他文件之后，才能继续回来阅读，这样就增加了多余的跳转，同时割裂了阅读的流畅性。<br>接下来就是实现:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/comments/router.js</span></span><br><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> express <span class="keyword">from</span> <span class="string">'express'</span>;</span><br><span class="line"><span class="keyword">import</span> commentsdb <span class="keyword">from</span> <span class="string">'./commentsdb'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = express.Router(&#123;mergeParams: <span class="literal">true</span>&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, (req, res)=&gt;&#123;</span><br><span class="line">  res.status(<span class="number">200</span>).send(<span class="string">'hello, comments'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/'</span>, (req, res)=&gt;&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'request params'</span>, req.params);</span><br><span class="line">  <span class="keyword">let</span> aComment = <span class="built_in">Object</span>.assign(&#123;postId:req.params.id&#125;, req.body); </span><br><span class="line">  commentsdb.save(aComment).then((data)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'creating comment successfully'</span>, data);</span><br><span class="line">    res.status(<span class="number">200</span>).send(data);</span><br><span class="line">  &#125;, (err)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'fail to create comment'</span>, err);</span><br><span class="line">    res.status(<span class="number">400</span>).send();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br></pre></td></tr></table></figure></p>
<p>这里有个地方需要注意<code>express.Router({mergeParams: true})</code>，之前在routers.js中的<code>router.use(&#39;/posts/:id/comments/&#39;, commentRouter);</code>可以让对comments的请求到达comments模块，但是到了之后<code>/posts/:id/comments</code>却无法通过<code>req.params</code>得到，后面google了一下需要加上<code>mergeParams</code>参数才能够得到上一层的url中的参数。其余代码这里就不贴了。</p>
<h2 id="获取comments"><a href="#获取comments" class="headerlink" title="获取comments"></a>获取comments</h2><p>获取comments在这里就只有一个需求，就是列出属于单个post的所有comments：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">'/'</span>, (req, res)=&gt;&#123;</span><br><span class="line">  commentsdb.getAll(req.params.id).then((data)=&gt;&#123;</span><br><span class="line">    res.status(<span class="number">200</span>).json(data);</span><br><span class="line">  &#125;, (err)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'failed to get all comments'</span>, err);</span><br><span class="line">    res.status(<span class="number">500</span>).send();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>这里，在测试的<code>before</code>方法中实现了对post的创建，这样在其余测试中就可以部分省略创建post：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test/comments/api.spec.js</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> postId;</span><br><span class="line"></span><br><span class="line">  before(<span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>&#123;</span><br><span class="line">    request(app)</span><br><span class="line">    .post(<span class="string">'/api/posts'</span>)</span><br><span class="line">    .send(aPost)</span><br><span class="line">    .expect((res)=&gt;&#123;</span><br><span class="line">      postId = res.body.id;</span><br><span class="line">    &#125;)</span><br><span class="line">    .expect(<span class="number">200</span>, done);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="增加独立的router来处理404的情况"><a href="#增加独立的router来处理404的情况" class="headerlink" title="增加独立的router来处理404的情况"></a>增加独立的router来处理404的情况</h2><p>先贴一段创建comment的代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/comments/router.js</span></span><br><span class="line">router.post(<span class="string">'/'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">  <span class="keyword">let</span> aComment = <span class="built_in">Object</span>.assign(&#123;postId:req.params.id&#125;, req.body); </span><br><span class="line">  commentsdb.save(aComment).then((data)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span> (lodash.isEmpty(data)) <span class="keyword">return</span> next();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'sending 200'</span>);</span><br><span class="line">    res.status(<span class="number">200</span>).send(data);</span><br><span class="line">  &#125;, (err)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'fail to create comment'</span>, err);</span><br><span class="line">    res.status(<span class="number">400</span>).send();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>由于comments属于post，所以在创建comment的时候需要传入postID，以确定该comment到底属于谁。既然传入了postID，那么自然存在postID找不到的情况，这时就应该返回404错误。对于404错误的返回，之前在post的router中使用的是<code>res.status(404).send();</code>，这里换一种方式。上面的代码中，如果返回的data是空，那么直接<code>return next()</code>，<code>next()</code>表示让后面的router函数来处理，而<code>return</code>表示跳过后面的操作，后面的函数为：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/routers.js</span></span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'*'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'inceptor request'</span>, req.method, req.path);</span><br><span class="line">  res.status(<span class="number">404</span>).send();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>这里在router分发的地方做一些全局的操作，这里将404的返回放到了所有router函数之后。还有就是回过头去想，在创建comments的时候并不需要判断data来返回是否404，因为就算传入的是错误的postId，已然会创建成功，所以后面做了一些改动。</p>
<h2 id="关系带来的考量"><a href="#关系带来的考量" class="headerlink" title="关系带来的考量"></a>关系带来的考量</h2><p>从Restful的角度来看，万物皆资源。posts是一种资源，comments也是一种资源。这两种资源并不是独立的，他们具有一种“属于”关系，也就是一对多关系。那么在对这两种资源进行操作的时候，这种“属于”关系会带来什么影响呢？<br>一般来说，资源的操作都包括四种，即增、删、改、查。我们分别考虑一下posts的操作对comments的影响以及comments的操作对posts的影响。<br>操作posts：</p>
<ul>
<li>create，posts可以没有comments，所以对post的创建可以跟comments没有关系</li>
<li>update，对posts进行修改的时候，一般情况下可以独立进行。这里的一般情况是指所改动的地方与comments没有关系。比如posts跟comments的关系是由postId来维系，那么修改post的时候没有修改postId，就没有必要对comments进行修改</li>
<li>get posts，查看posts列表的时候，一般不需要显示comments，所以跟comments没有关系；但如果需要显示comments的数量，就跟comments有关了</li>
<li>get post，即获取单独的一个post的时候，一般来说需要获取该post对应的comments，因此跟comments有关</li>
<li>delete post，删除post的时候需要将该post下面的comments全部删除</li>
</ul>
<p>操作comments：</p>
<ul>
<li>create，由于comments从属于某一个post，所以在创建comments的时候，需要指定一个postId，并且还需要验证该postId是有效的</li>
<li>update comments，如果不更改comment的从属关系，那么只需要更改comment，不太需要考虑post</li>
<li>get comments，从属关系，所以需要一个postId，并且需要验证该postId的有效性</li>
<li>get comment, 需要一个postId，或者一个单独的commentId</li>
<li>delete comment，删除comment的时候，一个commentId就足够了。</li>
</ul>
<p>这里考量的目的主要有两个：</p>
<ul>
<li>遇到资源与资源之间的关系的时候，代码就开始变复杂了。关系越来越纷杂的时候，代码就更复杂了。所以在关系出现或者增加的时候，需要考虑系统的设计或重构。</li>
<li>关系所带来的影响可以举一反三，一对多带来的影响可以进行具体的泛化<br>这里具体一点，就是在刚刚实现创建comment的时候，并没有验证postId的有效性，补上：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/comments/router.js</span></span><br><span class="line">router.post(<span class="string">'/'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">  postsdb.getOne(req.params.id)</span><br><span class="line">  .then((data)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span> (lodash.isEmpty(data)) <span class="keyword">return</span> next();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> aComment = <span class="built_in">Object</span>.assign(&#123;postId:req.params.id&#125;, req.body); </span><br><span class="line">    commentsdb.save(aComment).then((data)=&gt;&#123;</span><br><span class="line">      <span class="keyword">if</span> (lodash.isEmpty(data)) <span class="keyword">return</span> next();</span><br><span class="line">      res.status(<span class="number">200</span>).send(data);</span><br><span class="line">    &#125;, (err)=&gt;&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'fail to create comment'</span>, err);</span><br><span class="line">      res.status(<span class="number">400</span>).send();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, (err)=&gt;&#123;</span><br><span class="line">    res.status(<span class="number">404</span>).json(&#123;message: <span class="string">'cannot find post id.'</span>&#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这样，comments的建立就变得复杂了一些，后面我们再来看看能不能进行简化，以及如何简化。</p>
<h2 id="更新comment"><a href="#更新comment" class="headerlink" title="更新comment"></a>更新comment</h2><p>这里跟更新post类似，使用put方法，只是需要对传进来的post id进行存在性验证。看看关键代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/comments/router.js</span></span><br><span class="line"></span><br><span class="line">router.put(<span class="string">'/:commentId'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line"> postsdb.getOne(req.params.id)</span><br><span class="line"> .then(data =&gt; &#123;</span><br><span class="line">   <span class="keyword">if</span> (lodash.isEmpty(data)) <span class="keyword">return</span> next();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">let</span> newComment = req.body;</span><br><span class="line">   commentsdb.update(req.params.commentId, newComment)</span><br><span class="line">   .then(data=&gt;&#123;</span><br><span class="line">     res.status(<span class="number">200</span>).send(data);</span><br><span class="line">   &#125;, err =&gt; &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'fail to update comment'</span>, err);</span><br><span class="line">     res.status(<span class="number">400</span>).send();</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;, err =&gt; &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'updating comments '</span> + req.params.commentId + <span class="string">' error with post id '</span> + req.params.id);</span><br><span class="line">   res.status(<span class="number">404</span>).json(&#123;message: <span class="string">'cannot find post id.'</span>&#125;);</span><br><span class="line"> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/comments/commentsdb.js</span></span><br><span class="line"></span><br><span class="line">  update(id, data) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'commentsdb updating'</span>, id, data);</span><br><span class="line">    <span class="keyword">return</span> Comment.findByIdAndUpdate(id, &#123;</span><br><span class="line">      author: data.author,</span><br><span class="line">      content: data.content,</span><br><span class="line">      last_edit_date: <span class="built_in">Date</span>.now()</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="keyword">new</span>: <span class="literal">true</span>,</span><br><span class="line">      runValidator: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure></p>
<p>这里的代码跟之前创建comment的代码有些类似，同时看起来不是很爽，使用promise来表达同步思维，仍然让人觉得不是很舒服。下面就来重构重构。</p>
<h2 id="co的引入"><a href="#co的引入" class="headerlink" title="co的引入"></a>co的引入</h2><p><a href="https://github.com/tj/co" target="_blank" rel="external">co</a>，是一个库，可以借助ES6的<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Iterators_and_Generators" target="_blank" rel="external">generator</a>，关于generator的解释可以参考我的博客《ES6 generator探索》(<a href="http://koly.me/2015/07/25/ES6-generator%E6%8E%A2%E7%B4%A2/)，这里就不讲generator了，直接看看重构之前和之后的代码：" target="_blank" rel="external">http://koly.me/2015/07/25/ES6-generator%E6%8E%A2%E7%B4%A2/)，这里就不讲generator了，直接看看重构之前和之后的代码：</a><br>重构前：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">'/'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">  postsdb.getOne(req.params.id)</span><br><span class="line">  .then((data)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span> (lodash.isEmpty(data)) <span class="keyword">return</span> next();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> aComment = <span class="built_in">Object</span>.assign(&#123;postId:req.params.id&#125;, req.body); </span><br><span class="line">    commentsdb.save(aComment).then((data)=&gt;&#123;</span><br><span class="line">      res.status(<span class="number">200</span>).send(data);</span><br><span class="line">    &#125;, (err)=&gt;&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'fail to create comment'</span>, err);</span><br><span class="line">      res.status(<span class="number">400</span>).send();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, (err)=&gt;&#123;</span><br><span class="line">    res.status(<span class="number">404</span>).json(&#123;message: <span class="string">'cannot find post id.'</span>&#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>重构后：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/comments/router.js</span></span><br><span class="line"><span class="keyword">import</span> co <span class="keyword">from</span> <span class="string">'co'</span>;</span><br><span class="line">router.post(<span class="string">'/'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">  co(<span class="function"><span class="keyword">function</span> *(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> aPost = <span class="keyword">yield</span> postsdb.getOne(req.params.id);</span><br><span class="line">    <span class="keyword">if</span> (lodash.isEmpty(aPost)) <span class="keyword">return</span> next();</span><br><span class="line">    <span class="keyword">let</span> aComment = <span class="built_in">Object</span>.assign(&#123;postId:req.params.id&#125;, req.body); </span><br><span class="line">    <span class="keyword">let</span> result = <span class="keyword">yield</span> commentsdb.save(aComment);</span><br><span class="line">    res.status(<span class="number">200</span>).send(result);</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(err =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'err'</span>, err);</span><br><span class="line">    <span class="keyword">if</span> (err.kind === <span class="string">'ObjectId'</span>) <span class="keyword">return</span> res.status(<span class="number">404</span>).json(&#123;message: <span class="string">'cannot find post id'</span>&#125;);</span><br><span class="line">    res.status(<span class="number">400</span>).json(&#123;message:<span class="string">'valiation error'</span>&#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>可以看到重构之后的代码比原来的代码可读性要好一些了，更“同步”了。在实现的过程中，需要引入<a href="https://github.com/tj/co" target="_blank" rel="external">co</a>，同样也是通过npm安装，然后为了让babeljs可以编译generator，还需要安装<a href="https://babeljs.io/docs/usage/polyfill/" target="_blank" rel="external">babel-polyfill</a>。并且在<code>app.js</code>中添加<code>import &quot;babel-polyfill&quot;;</code></p>
<h2 id="使用ES7中的async及await"><a href="#使用ES7中的async及await" class="headerlink" title="使用ES7中的async及await"></a>使用ES7中的async及await</h2><p>上面的co及generator的形式已经不错了，但为了追赶潮流，我们还可以使用ES7中的async及await:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/comments/router.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;wrap&#125; <span class="keyword">from</span> <span class="string">'../utils/utils'</span>;</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/'</span>, wrap(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      <span class="keyword">let</span> aPost = <span class="keyword">await</span> postsdb.getOne(req.params.id);</span><br><span class="line">      <span class="keyword">if</span> (lodash.isEmpty(aPost)) <span class="keyword">return</span> next();</span><br><span class="line">      <span class="keyword">let</span> aComment = <span class="built_in">Object</span>.assign(&#123;postId:req.params.id&#125;, req.body); </span><br><span class="line">      <span class="keyword">let</span> result = <span class="keyword">await</span> commentsdb.save(aComment);</span><br><span class="line">      res.status(<span class="number">200</span>).json(result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err)&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'err'</span>, err);</span><br><span class="line">      <span class="keyword">if</span> (err.kind === <span class="string">'ObjectId'</span>) <span class="keyword">return</span> res.status(<span class="number">404</span>).json(&#123;message: <span class="string">'cannot find post id'</span>&#125;);</span><br><span class="line">      res.status(<span class="number">400</span>).json(&#123;message:<span class="string">'valiation error'</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure></p>
<p>其中的wrap是由于express本身不支持async而添加的，其代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/utils/utils.js</span></span><br><span class="line"><span class="meta"></span><br><span class="line">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wrap = fn =&gt; (...args) =&gt; fn(...args);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;wrap&#125;;</span><br></pre></td></tr></table></figure></p>
<p>wrap函数接收一个函数作为参数返回另一个函数。返回的函数接收多个参数，并调用wrap函数接收的参数同时应用这些参数。async function也是一个function，所以其内部代码的执行，已然需要对该函数的调用。</p>
<p>为了使babeljs能够编译async，需要引入<a href="https://www.npmjs.com/package/babel-plugin-transform-async-to-generator" target="_blank" rel="external">babel-plugin-transform-async-to-generator</a>，并且在<code>.babelrc</code>中加上一些代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"presets"</span>: [<span class="string">"es2015"</span>],</span><br><span class="line">    <span class="string">"plugins"</span>: [<span class="string">"transform-async-to-generator"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="删除comment"><a href="#删除comment" class="headerlink" title="删除comment"></a>删除comment</h2><p>继续使用上面的async进行删除：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/comments/router.js</span></span><br><span class="line"></span><br><span class="line">router.delete(<span class="string">'/:commentId'</span>, wrap(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">   <span class="keyword">await</span> commentsdb.deleteOne(req.params.commentId);</span><br><span class="line">   res.status(<span class="number">200</span>).send();</span><br><span class="line"> &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'delete comment error'</span>, err);</span><br><span class="line">   res.status(<span class="number">404</span>).json(&#123;message: <span class="string">'comment not found'</span>&#125;);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure></p>
<p>注意这里并没有对传入的post id进行存在验证。我觉得没有必要进行验证，删除comment的时候对post没有影响。这时候有个问题，既然传入的post id没有作用，那么有必要进行收集吗？就delete操作本身来看，没有必要，但是从comment作为资源的角度看，依然有必要，因为url代表了一种关系，删除的不是一个独立的comment，而是一个跟post有关系的comment。纵然没有用到post id，但关系还是需要url来表示的。</p>
<h2 id="删除post"><a href="#删除post" class="headerlink" title="删除post"></a>删除post</h2><p>根据之前的post与comment的关系分析，在删除post的时候，需要同时删除属于该post的comments。这里就设计到“事务”，即删除comments是删除post的一部分，如果comments删除失败，而post删除成功，那么整体上就不算成功。关于事务，最经典的例子就是简单的银行转账的例子，A账户需要把钱转到B账户，就有两个步骤：1）扣除A账户上的钱；2）将扣除的钱加到B账户上。处理转账操作时需要将这两个操作捆绑在一起，必须两个都成功，转账操作才算成功，只要其中任意一个失败，转账就失败。失败的情况就有两种第一步扣除失败及第二部增加失败。扣除失败的情况简单，只需要返回转账失败就可以了；而增加失败的情况多出一步，除了返回转账失败外，还需要将A账户上扣除的钱增加回去(这一步称为回滚)。那么这两步捆绑的操作，就是一个“事务”。<br>如何实现事务呢？经过一番搜索，发现mongodb本身不支持事务处理，如果要实现事务操作的话，需要自己实现诸如<a href="">两步提交</a>的形式。心里一想，这也有点复杂了吧，这又不是一个分布式系统。mongodb为什么不支持事务处理呢？有几个原因，其中一个是部分系统并不需要事务，而实现事务会影响数据库的可扩展性。那么回到post和comments，这里到底需要不需要严格的事务呢？首先post对于用户来说是重要的，但是comment相对而言就不太重要了。一个post的comment少了一条或者几条，应该并没有多大的影响。而且如果一个post要被删除了，意味着该post存在的意义不大了，既然post存在的意义不大，那么可以认为其comments的意义就不大。所以这里post和comment的权重是不一样的，post的权重要大一点，起决定性作用，即post的删除成功是由post决定的。所以删除成功的情况，必须保证post确实被删除了。删除成功比较好办，两个都删除了就返回成功。如果post删除失败或者comments删除失败，就返回失败。只是由于这里没有事务操作，所以没有回滚。这时候就有两种处理顺序：1)删除comments，成功后删除post；2）删除post，成功后删除comments。第二种情况，如果post删除的时候失败了，用户无法通过同样的接口重试，这样数据库里面就会存在一些没有对应post的comments。从用户的角度，删除失败之后再去访问post应该可以可以访问，但是实际确无法访问；第一种情况，删除失败，用户依然可以访问post，并且可以重试。明显，这里选择第二种处理方式。<br>那么，看看代码：</p>
<p>测试：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'should delete a post with comments'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> aComment = &#123;</span><br><span class="line">      <span class="string">"author"</span>:<span class="string">"koy"</span>,</span><br><span class="line">      <span class="string">"content"</span>:<span class="string">"this is a comment"</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">let</span> postId;</span><br><span class="line">    request(app)</span><br><span class="line">    .post(<span class="string">'/api/posts'</span>)</span><br><span class="line">    .send(aPost)</span><br><span class="line">    .expect(<span class="string">'Content-Type'</span>, <span class="regexp">/json/</span>)</span><br><span class="line">    .expect(<span class="number">200</span>)</span><br><span class="line">    .end((err, res)=&gt;&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">      postId = res.body.id;</span><br><span class="line">      request(app)</span><br><span class="line">      .post(<span class="string">'/api/posts/'</span>+postId+<span class="string">'/comments'</span>)</span><br><span class="line">      .send(aComment)</span><br><span class="line">      .expect(<span class="number">200</span>)</span><br><span class="line">      .end((err, res)=&gt;&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">        request(app)</span><br><span class="line">        .delete(<span class="string">'/api/posts/'</span>+postId)</span><br><span class="line">        .expect(<span class="number">200</span>)</span><br><span class="line">        .end((err, res)=&gt;&#123;</span><br><span class="line">          <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">          request(app)</span><br><span class="line">          .get(<span class="string">'/api/posts/'</span>+postId+<span class="string">'/comments'</span>)</span><br><span class="line">          .expect(<span class="number">200</span>)</span><br><span class="line">          .expect((res)=&gt;&#123;</span><br><span class="line">            res.body.should.be.deepEqual([]);</span><br><span class="line">          &#125;)</span><br><span class="line">          .end(done);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure></p>
<p>实现：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/posts/router.js</span></span><br><span class="line"><span class="keyword">import</span> postsdb <span class="keyword">from</span> <span class="string">'./postsdb'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;wrap&#125; <span class="keyword">from</span> <span class="string">'../utils/utils'</span>;</span><br><span class="line"><span class="keyword">import</span> commentsdb <span class="keyword">from</span> <span class="string">'../comments/commentsdb'</span>;</span><br><span class="line"></span><br><span class="line">router.delete(<span class="string">'/:id'</span>, wrap(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> comments = <span class="keyword">await</span> commentsdb.getAll(req.params.id);</span><br><span class="line">    <span class="keyword">if</span> (comments !== <span class="literal">null</span> &amp;&amp; comments.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> c <span class="keyword">of</span> comments) &#123; </span><br><span class="line">        <span class="keyword">await</span> commentsdb.deleteOne(c._id);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'post id'</span>, req.params.id);</span><br><span class="line">    <span class="keyword">await</span> postsdb.deleteOne(req.params.id);</span><br><span class="line">    res.status(<span class="number">200</span>).send();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'deleting post error'</span>, err);</span><br><span class="line">    res.status(<span class="number">404</span>).send();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure></p>
<p>其中的<code>for (let c of comments)</code>替换成<code>comments.forEach(c =&gt; await commentsdb.deleteOne(c._id))</code>会出错，因为此时的await并没有在一个async函数中。如果将forEach中的匿名函数改为async函数依然不行，因为此时的await并没有在router.delete所传入的async函数中，而是在forEach的子async函数中，它await的就是子函数，此时父async函数会在没有await的情况下直接退出。<br>还有就是await的部分还可以进一步简化：<br>简化前：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (comments !== <span class="literal">null</span> &amp;&amp; comments.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="comment">// forEach not working here</span></span><br><span class="line">  <span class="comment">//comments.forEach(function(c) &#123;</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> c <span class="keyword">of</span> comments) &#123; </span><br><span class="line">    <span class="keyword">await</span> commentsdb.deleteOne(c._id);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//&#125;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>简化后：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (comments !== <span class="literal">null</span> &amp;&amp; comments.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> deletePromise = comments.map(c =&gt; commentsdb.deleteOne(c._id));</span><br><span class="line">  <span class="keyword">await</span> <span class="built_in">Promise</span>.all(deletePromise);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到这里，comments相关的功能就大致开发完成了。这里只考虑了happy path的情况，下面来聊聊错误处理。</p>
<h2 id="异常情况处理"><a href="#异常情况处理" class="headerlink" title="异常情况处理"></a>异常情况处理</h2><p>写到这里，再来考虑错误情况，总结一下，基本只有两种错误：1）找不到，比如删除的时候根据id找不到对应的记录等，此时应该返回404错误；2）传入的参数错误，比如创建post的时候content为空，此时应该是400错误。不止一个api会返回这样的错误，那么对于错误处理可以集中在一处进行吗？答案当然是可以。既然集中在一处，自然要从api的处理函数中分出去先，还好express提供了next函数。这个函数如果有参数传入的话，会跳过后面的route处理，直接进入下一个错误处理函数，那么什么函数才算是一个错误处理函数呢？看看代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/posts/router.js</span></span><br><span class="line">router.use((err, req, res, next)=&gt;&#123;</span><br><span class="line">  res.status(<span class="number">404</span>).send();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>express里面错误处理函数就是有四个参数的函数。其中第一个参数是err对象，即传给next函数的参数。这里以post的删除为例，来看看具体的错误处理：<br>重构前：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/posts/router.js</span></span><br><span class="line"></span><br><span class="line">router.delete(<span class="string">'/:id'</span>, wrap(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> comments = <span class="keyword">await</span> commentsdb.getAll(req.params.id);</span><br><span class="line">    <span class="keyword">if</span> (comments !== <span class="literal">null</span> &amp;&amp; comments.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> deletePromise = comments.map(c =&gt; commentsdb.deleteOne(c._id));</span><br><span class="line">      <span class="keyword">await</span> <span class="built_in">Promise</span>.all(deletePromise);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'post id'</span>, req.params.id);</span><br><span class="line">    <span class="keyword">await</span> postsdb.deleteOne(req.params.id);</span><br><span class="line">    res.status(<span class="number">200</span>).send();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'deleting post error'</span>, err);</span><br><span class="line">    res.status(<span class="number">404</span>).send();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure></p>
<p>重构后：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">router.delete(<span class="string">'/:id'</span>, wrap(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> comments = <span class="keyword">await</span> commentsdb.getAll(req.params.id);</span><br><span class="line">    <span class="keyword">if</span> (comments !== <span class="literal">null</span> &amp;&amp; comments.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'deleting comments of posts'</span>, comments);</span><br><span class="line">      <span class="keyword">const</span> deletePromise = comments.map(c =&gt; commentsdb.deleteOne(c._id));</span><br><span class="line">      <span class="keyword">await</span> <span class="built_in">Promise</span>.all(deletePromise);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> result =  <span class="keyword">await</span> postsdb.deleteOne(req.params.id);</span><br><span class="line">    <span class="keyword">if</span> (lodash.isEmpty(result)) <span class="keyword">return</span> next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`cannot find post with <span class="subst">$&#123;req.params.id&#125;</span>`</span>));</span><br><span class="line">    res.status(<span class="number">200</span>).send();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    next(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure></p>
<p>具体的变化在于result为空的情况以及catch里面的情况，之前是直接在这里处理，现在是通过<code>next</code>函数将错误处理delegate出去。其中使用了<code>new Error(...)</code>，当然还可以使用自己定义的Error：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/errors/errors.js</span></span><br><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotFound</span> <span class="keyword">extends</span> <span class="title">Error</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(message) &#123;</span><br><span class="line">    <span class="keyword">super</span>(message);</span><br><span class="line">    <span class="keyword">this</span>.code = <span class="number">404</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;NotFound&#125;;</span><br></pre></td></tr></table></figure></p>
<p>比如上面定义了一个404 Not Found error。本来想使用<code>err instanceof NotFound</code>来判断具体抛出的是什么类型的error，结果发现这句在纯粹的ES6环境下是可以工作的，但是在babel的环境下是不行的。所以只有放一个error type在具体的error类里了：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/errors/errors.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotFound</span> <span class="keyword">extends</span> <span class="title">Error</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(message) &#123;</span><br><span class="line">    <span class="keyword">super</span>(message);</span><br><span class="line">    <span class="keyword">this</span>.code = <span class="string">'404'</span>;</span><br><span class="line">    <span class="keyword">this</span>.type = <span class="string">'NotFound'</span>; <span class="comment">// should be same as class name</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/posts/router.js</span></span><br><span class="line">router.use((err, req, res, next)=&gt;&#123;</span><br><span class="line">  <span class="comment">// instanceof doesn't work here because of babeljs, it should work in pure ES6 environment</span></span><br><span class="line">  <span class="comment">//console.log('error handler', err instanceof NotFound, err);</span></span><br><span class="line">  <span class="keyword">if</span> (err.type === <span class="string">'NotFound'</span> || err.name === <span class="string">'CastError'</span>) <span class="keyword">return</span> res.status(<span class="number">404</span>).send();</span><br><span class="line">  res.status(<span class="number">500</span>).send();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>下面的是具体的使用。接下来就是一阵的重构了，最后考虑到对于posts模块和comments模块，错误处理基本一致，所以讲error函数放到了<code>routers.js</code>中：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/routers.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> composeErrorJson = (errors) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> result = &#123;&#125;;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> errors) &#123;</span><br><span class="line">    result[key] = errors[key].message;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">router.use((err, req, res, next)=&gt;&#123;</span><br><span class="line">  <span class="comment">// instanceof doesn't work here because of babeljs, it should work in pure ES6 environment</span></span><br><span class="line">  <span class="comment">//console.log('error handler', err instanceof NotFound, err);</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'error handler for posts'</span>, err);</span><br><span class="line">  <span class="keyword">if</span> (err.type === <span class="string">'NotFound'</span> || err.name === <span class="string">'CastError'</span>) <span class="keyword">return</span> res.status(<span class="number">404</span>).send();</span><br><span class="line">  <span class="keyword">if</span> (err.name === <span class="string">'ValidationError'</span>) <span class="keyword">return</span> res.status(<span class="number">400</span>).json(composeErrorJson(err.errors));</span><br><span class="line">  res.status(<span class="number">500</span>).send();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>至此，error处理就先这样了。</p>
<p>对于comments模块的编写就大概完成了，我想一定有一些bug，就等后面真实调用的时候再来发现和修改了。</p>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="pagination" role="pagination">
    
    <a class="pull-left" href="/2016/04/22/RPC-and-Apache-Thrift/" style="float: left;">
        ← RPC and Apache Thrift
    </a>
    
    
    <a class="pull-right" href="/2016/03/11/Javascript原型链/">
        Javascript原型链 →
    </a>
    
</nav>

        <div class="duoshuo">


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "koly";

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By koly. All Rights Reserved.
                </p>
                <p>Theme By <a href="//go.kieran.top" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/kolyjjj" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    
                    
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->

      <!-- Load our scripts -->
        
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };
    
    resizeHero();
    
    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/jquery.flexslider-min.js"></script><!-- Flexslider plugin -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->

<!-- Initiate flexslider plugin -->
<script type="text/javascript">
    $(document).ready(function($) {
      $('.flexslider').flexslider({
        animation: "fade",
        prevText: "",
        nextText: "",
        directionNav: true
      });
    });
</script>
      


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?b9e58ce86835727eab5c9fa8c11c7f1f";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



</body>
</html>
